#!/usr/bin/env node

const minimist = require("minimist");

const argv = minimist(process.argv.slice(2), {
  string: ["title", "description", "assignee", "labels", "issue-type"],
  alias: {
    s: "title",
    d: "description",
    a: "assignee",
    l: "labels",
    c: "custom-field",
    t: "issue-type",
  },
});

const issueId = argv._[0];
const title = argv.title;
const description = argv.description;
const assignee = argv.assignee;
const labels = argv.labels ? argv.labels.split(",") : undefined;
const customFieldInputs = argv["custom-field"];
const issueType = argv["issue-type"];

if (!issueId) {
  console.error("Usage: update-jira-issue <issue_id> [options]");
  console.error("Options:");
  console.error("  -s, --title <text>           Issue title/summary");
  console.error("  -d, --description <text>     Issue description");
  console.error("  -a, --assignee <username>    Assignee username");
  console.error("  -l, --labels <label1,label2> Comma-separated labels");
  console.error(
    "  -c, --custom-field <key=val> Custom field as key=value (can be used multiple times)",
  );
  console.error("  -t, --issue-type <type>      Issue type");
  process.exit(1);
}

const { makePutRequest, parseCustomFields } = require("../shared/__shared");

const path = require("path");
const assert = require("assert");
require("dotenv").config({ path: path.join(__dirname, "..", ".env") });

const JIRA_URL = process.env.JIRA_URL;
const JIRA_API_TOKEN = process.env.JIRA_API_TOKEN;

assert(JIRA_URL, "Missing JIRA_URL in .env file");
assert(JIRA_API_TOKEN, "Missing JIRA_API_TOKEN in .env file");

/**
 * @param {string} issueId
 * @param {Object} updates
 * @returns {Promise<void>}
 */
async function updateIssue(
  issueId,
  { title, description, assignee, labels, customFields, issueType },
) {
  const payload = {
    fields: {},
  };

  if (title) {
    payload.fields.summary = title;
  }

  if (description !== undefined) {
    payload.fields.description = description;
  }

  if (assignee) {
    payload.fields.assignee = { name: assignee };
  }

  if (labels) {
    payload.fields.labels = labels;
  }

  if (issueType) {
    payload.fields.issuetype = { name: issueType };
  }

  if (customFields && Object.keys(customFields).length > 0) {
    Object.assign(payload.fields, customFields);
  }

  try {
    const url = `${JIRA_URL}/rest/api/2/issue/${issueId}`;
    await makePutRequest(url, JIRA_API_TOKEN, payload);
  } catch (error) {
    return Promise.reject(error.response?.data || error.message);
  }
}

async function main() {
  const customFields = parseCustomFields(customFieldInputs);

  await updateIssue(issueId, {
    title,
    description,
    assignee,
    labels,
    customFields,
    issueType,
  });
  const browseUrl = `${JIRA_URL}/browse/${issueId}`;
  console.log(`Issue ${issueId} updated successfully: ${browseUrl}`);
}

main().catch((error) => {
  console.error(error);
  process.exit(1);
});
