#!/usr/bin/env node

const minimist = require("minimist");

const argv = minimist(process.argv.slice(2), {
  string: ["description", "assignee", "labels", "issue-type"],
  default: {
    "issue-type": "Story",
  },
  alias: {
    d: "description",
    a: "assignee",
    l: "labels",
    c: "custom-field",
    t: "issue-type",
  },
});

const title = argv._[0];
const description = argv.description || "";
const assignee = argv.assignee;
const labels = argv.labels ? argv.labels.split(",") : undefined;
const customFieldInputs = argv["custom-field"];
const issueType = argv["issue-type"];

// Parse custom fields as key=value pairs
const customFields = {};
if (customFieldInputs) {
  const inputs = Array.isArray(customFieldInputs)
    ? customFieldInputs
    : [customFieldInputs];
  inputs.forEach((input) => {
    const parts = input.split("=");
    if (parts.length === 2) {
      customFields[parts[0]] = parts[1];
    }
  });
}

if (!title) {
  console.error("Usage: new-jira-issue <title> [options]");
  console.error("Options:");
  console.error("  -d, --description <text>     Issue description");
  console.error("  -a, --assignee <username>    Assignee username");
  console.error("  -l, --labels <label1,label2> Comma-separated labels");
  console.error(
    "  -c, --custom-field <key=val> Custom field as key=value (can be used multiple times)",
  );
  console.error("  -t, --issue-type <type>      Issue type (default: Story)");
  process.exit(1);
}

const { makeJsonPostRequest } = require("../shared/__shared");

const path = require("path");
const assert = require("assert");
require("dotenv").config({ path: path.join(__dirname, "..", ".env") });

const JIRA_URL = process.env.JIRA_URL;
const JIRA_API_TOKEN = process.env.JIRA_API_TOKEN;
const JIRA_PROJECT_KEY = process.env.JIRA_PROJECT_KEY;

assert(JIRA_URL, "Missing JIRA_URL in .env file");
assert(JIRA_API_TOKEN, "Missing JIRA_API_TOKEN in .env file");
assert(JIRA_PROJECT_KEY, "Missing JIRA_PROJECT_KEY in .env file");

/**
 * @typedef {Object} DTOCreateIssue
 * @property {string} id
 * @property {string} key
 * @property {string} self
 */

/**
 * @param param0
 * @returns {Promise<DTOCreateIssue>}
 */
function createIssue({
  title,
  description,
  assignee,
  labels,
  customFields,
  issueType,
}) {
  const payload = {
    fields: {
      project: { key: JIRA_PROJECT_KEY },
      summary: title,
      description: description,
      issuetype: { name: issueType },
    },
  };

  if (assignee) {
    payload.fields.assignee = { name: assignee };
  }

  if (labels) {
    payload.fields.labels = labels;
  }

  if (customFields && Object.keys(customFields).length > 0) {
    Object.assign(payload.fields, customFields);
  }

  try {
    const url = `${JIRA_URL}/rest/api/2/issue`;
    return makeJsonPostRequest(url, JIRA_API_TOKEN, payload);
  } catch (error) {
    return Promise.reject(error.response?.data || error.message);
  }
}

async function main() {
  const response = await createIssue({
    title,
    description,
    assignee,
    labels,
    customFields,
    issueType,
  });
  if (!response || !response.key) {
    console.error(response);
    throw new Error("Failed to create JIRA issue");
  }
  const browseURL = `${JIRA_URL}/browse/${response.key}`;
  console.log({ browseURL });
}

main().catch((error) => {
  console.error(error);
  process.exit(1);
});
